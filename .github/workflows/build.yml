name: Kernel Builder

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Kernel Manifest'
        required: true
        default: 'https://github.com/udyneos-prjkt/android_kernel-manifest'
      MANIFEST_BRANCH:
        description: 'Kernel Manifest Branch'
        required: true
        default: 'realme/sm4250'
      BUILD_CONFIG:
        description: 'Customized build.config file'
        required: true
        default: 'sm4250-kernel/build.config.sm4250'
      KERNEL_IMAGE_NAME:
        description: 'Image, Image.gz, Image.gz-dtb, etc.'
        required: true
        default: 'Image.gz'
      ANYKERNEL3:
        description: 'Make flashable AnyKernel3 zip'
        type: boolean
        required: false
        default: false
      MAKE_CLEAN:
        description: 'Run make clean before building'
        type: boolean
        required: false
        default: true
      LTO:
        description: 'full,thin,none'
        required: false
        default: 'none'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    permissions:
      contents: write
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Build Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          bc \
          bison \
          build-essential \
          cpio \
          curl \
          flex \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabihf \
          libssl-dev \
          libelf-dev \
          lz4 \
          lzop \
          rsync \
          device-tree-compiler \
          python3 \
          git \
          zip \
          unzip \
          kmod
        sudo apt-get clean

    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 25

    - name: Install Repo Tool
      run: |
        mkdir -p ~/bin
        curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/local/bin/repo
        echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
        source ~/.bashrc

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global color.ui false
        git config --global core.compression 9

    - name: Initialize and Sync Repository
      run: |
        mkdir -p kernel_build
        cd kernel_build
        
        echo "Initializing repo with manifest: ${{ inputs.MANIFEST_URL }}"
        repo init \
          --depth=1 \
          --no-repo-verify \
          -u "${{ inputs.MANIFEST_URL }}" \
          -b "${{ inputs.MANIFEST_BRANCH }}"
        
        echo "Syncing repositories..."
        repo sync \
          --current-branch \
          --no-tags \
          --no-clone-bundle \
          --optimized-fetch \
          --prune \
          -j$(nproc --all) || {
            echo "First sync failed, retrying with force sync..."
            repo sync \
              --force-sync \
              --no-tags \
              --no-clone-bundle \
              -j$(nproc --all)
          }

    - name: Clean Build Directory
      if: inputs.MAKE_CLEAN == true
      run: |
        cd kernel_build
        if [ -f "build/build.sh" ]; then
          BUILD_CONFIG="${{ inputs.BUILD_CONFIG }}" build/build.sh clean  || true
        fi

    - name: Build Kernel
      run: |
        cd kernel_build
        
        # Set environment variables for build
        export ARCH=arm64
        export SUBARCH=arm64
        export KBUILD_BUILD_USER="mnrdnn"
        export KBUILD_BUILD_HOST="GitHub-Action"
        export LTO=${{ inputs.LTO}}
        
        # Determine number of parallel jobs
        JOBS=$(($(nproc --all) * 4))
        
        echo "Starting kernel build with $JOBS parallel jobs..."
        echo "Build config: ${{ inputs.BUILD_CONFIG }}"
        
        # Start build with tee for logging
        time BUILD_CONFIG="${{ inputs.BUILD_CONFIG }}" \
          build/build.sh -j$JOBS 2>&1 | tee build.log
        
        # Check if build was successful
        if [ $? -eq 0 ]; then
          echo "âœ… Kernel build completed successfully!"
        else
          echo "âŒ Kernel build failed!"
          exit 1
        fi
        
    - name: Find and Collect Build Artifacts
      run: |
        mkdir -p artifacts
        
        # Find kernel image
        echo "Searching for kernel image: ${{ inputs.KERNEL_IMAGE_NAME }}"
        
        # Search in common output directories
        find kernel_build -type f -name "${{ inputs.KERNEL_IMAGE_NAME }}" 2>/dev/null | while read -r file; do
          echo "Found: $file"
          cp -v "$file" artifacts/
        done
        
        # Also search for common compressed variants
        for ext in "" ".gz" ".lz4" ".xz" ".zst"; do
          find kernel_build -type f -name "${{ inputs.KERNEL_IMAGE_NAME }}${ext}" 2>/dev/null | while read -r file; do
            echo "Found: $file"
            cp -v "$file" artifacts/
          done
        done
        
        # Copy build log
        cp -v kernel_build/build.log artifacts/ 2>/dev/null || true
        
        # Copy other important artifacts
        find kernel_build -type f -name "*.dtb" "*.dtbo" "*.ko" 2>/dev/null | head -5 | while read -r file; do
          cp -v "$file" artifacts/
        done
        
        # List collected artifacts
        echo "ðŸ“¦ Collected artifacts:"
        ls -la artifacts/

    - name: Create AnyKernel3 Zip
      if: inputs.ANYKERNEL3 == true
      continue-on-error: true
      run: |
         cd kernel_build
         if [ -d "Anykernel3" ]; then
           cp ../artifacts/Image.gz Anykernel3/
           cd Anykernel3
           zip -r9 Flashable-Kernel-Anykernel3.zip * -x .git README.md *placeholder
           mv Flashable-Kernel-Anykernel3.zip ../../artifacts
         fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_id }}
        path: artifacts/
        retention-days: 7

    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_id }}
        name: "Kernel Build #${{ github.run_id }}"
        body: |
          ## Build Information
          - **Builder Version**: Stable-v1.1
          - **Manifest**: [manifests](${{ inputs.MANIFEST_URL }}) 
          - **Branch**: `${{ inputs.MANIFEST_BRANCH }}`
          - **Build Config**: `${{ inputs.BUILD_CONFIG }}`
          - **Target Image**: `${{ inputs.KERNEL_IMAGE_NAME }}`
          - **AnyKernel3**: ${{ inputs.ANYKERNEL3 }}
          
          
          ## Artifacts
          See attached artifacts for build outputs.
        draft: false
        prerelease: false
        files: |
           artifacts/*.gz
           artifacts/*.zip
           artifacts/*.log
